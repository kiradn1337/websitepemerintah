<!-- User Detail -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-user me-2"></i> Detail Pengguna</h2>
  <a href="/superadmin/users" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Kembali ke Daftar Pengguna
  </a>
</div>

<div class="row">
  <!-- User Profile Card -->
  <div class="col-lg-4 mb-4">
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="mb-0">Informasi Pengguna</h5>
      </div>
      <div class="card-body">
        <div class="text-center mb-4">
          <div class="avatar avatar-xl bg-<%= user.role === 'superadmin' ? 'danger' : (user.role === 'admin' ? 'warning' : 'info') %> text-white mx-auto mb-3">
            <%= user.fullName.substring(0, 2).toUpperCase() %>
          </div>
          <h4><%= user.fullName %></h4>
          <span class="badge bg-<%= user.role === 'superadmin' ? 'danger' : (user.role === 'admin' ? 'warning' : 'info') %>">
            <%= user.role %>
          </span>
          <span class="badge bg-<%= user.isActive ? 'success' : 'secondary' %> ms-2">
            <%= user.isActive ? 'Aktif' : 'Tidak Aktif' %>
          </span>
        </div>
        
        <div class="border-top pt-3">
          <div class="mb-3">
            <div class="text-muted mb-1">Email</div>
            <div class="fw-bold"><i class="fas fa-envelope me-2 text-primary"></i><%= user.email %></div>
          </div>

          <div class="mb-3">
            <div class="text-muted mb-1">Terakhir Login</div>
            <div class="fw-bold">
              <i class="fas fa-clock me-2 text-primary"></i>
              <% if (user.lastLogin) { %>
                <%= new Date(user.lastLogin).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
              <% } else { %>
                <span class="text-muted">Belum pernah login</span>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <div class="text-muted mb-1">Tanggal Daftar</div>
            <div class="fw-bold">
              <i class="fas fa-calendar-alt me-2 text-primary"></i>
              <%= new Date(user.createdAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }) %>
            </div>
          </div>

          <% if (user.notes) { %>
            <div class="mb-3">
              <div class="text-muted mb-1">Catatan</div>
              <div class="fw-bold">
                <i class="fas fa-sticky-note me-2 text-primary"></i>
                <%= user.notes %>
              </div>
            </div>
          <% } %>
        </div>
      </div>
      <div class="card-footer bg-white">
        <div class="d-flex justify-content-between">
          <a href="/superadmin/users/<%= user.id %>/edit" class="btn btn-primary">
            <i class="fas fa-edit me-1"></i> Edit
          </a>
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="fas fa-trash-alt me-1"></i> Hapus
          </button>
        </div>
      </div>
    </div>
    
    <!-- Reset Password Card -->
    <div class="card mt-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Reset Password</h5>
      </div>
      <div class="card-body">
        <p>Anda dapat mengirimkan tautan reset password ke email pengguna ini.</p>
        <form action="/superadmin/users/<%= user.id %>/send-reset" method="POST">
          <button type="submit" class="btn btn-warning w-100">
            <i class="fas fa-key me-1"></i> Kirim Link Reset Password
          </button>
        </form>
        
        <hr>
        
        <p>Atau Anda dapat mengatur password baru secara langsung:</p>
        <form action="/superadmin/users/<%= user.id %>/reset-password" method="POST" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="newPassword" class="form-label">Password Baru</label>
            <div class="input-group">
              <input type="password" class="form-control" id="newPassword" name="newPassword" required>
              <button class="btn btn-outline-secondary toggle-password" type="button" data-target="newPassword">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
            <div class="input-group">
              <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required>
              <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirmNewPassword">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          
          <button type="submit" class="btn btn-danger w-100">
            <i class="fas fa-lock me-1"></i> Reset Password
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- User Activity Tabs -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header bg-white">
        <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="personal-data-tab" data-bs-toggle="tab" data-bs-target="#personal-data" type="button" role="tab" aria-controls="personal-data" aria-selected="true">
              <i class="fas fa-database me-1"></i> Data Pribadi
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">
              <i class="fas fa-file-alt me-1"></i> File
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="false">
              <i class="fas fa-history me-1"></i> Aktivitas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
              <i class="fas fa-list me-1"></i> Log Login
            </button>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content" id="userTabContent">
          <!-- Personal Data Tab -->
          <div class="tab-pane fade show active" id="personal-data" role="tabpanel" aria-labelledby="personal-data-tab">
            <% if (personalData && personalData.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Judul</th>
                      <th>Kategori</th>
                      <th>Dibuat</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% personalData.forEach(data => { %>
                      <tr>
                        <td><%= data.title %></td>
                        <td><%= data.category %></td>
                        <td><%= new Date(data.createdAt).toLocaleDateString('id-ID') %></td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <a href="/superadmin/personal-data/<%= data.id %>" class="btn btn-outline-secondary">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="/superadmin/personal-data/<%= data.id %>/edit" class="btn btn-outline-primary">
                              <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteDataModal" 
                                    data-id="<%= data.id %>" 
                                    data-title="<%= data.title %>">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-center py-4">
                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                <p>Tidak ada data pribadi yang ditemukan untuk pengguna ini.</p>
              </div>
            <% } %>
          </div>
          
          <!-- Files Tab -->
          <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
            <% if (files && files.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Nama File</th>
                      <th>Tipe</th>
                      <th>Ukuran</th>
                      <th>Dibuat</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% files.forEach(file => { %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="file-icon me-2">
                              <i class="fas fa-<%= file.fileType.includes('image') ? 'image' : (file.fileType.includes('pdf') ? 'file-pdf' : (file.fileType.includes('word') ? 'file-word' : (file.fileType.includes('excel') ? 'file-excel' : (file.fileType.includes('zip') ? 'file-archive' : 'file-alt')))) %>"></i>
                            </div>
                            <span><%= file.originalName %></span>
                          </div>
                        </td>
                        <td><%= file.fileType %></td>
                        <td><%= (file.fileSize / 1024).toFixed(2) %> KB</td>
                        <td><%= new Date(file.createdAt).toLocaleDateString('id-ID') %></td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <a href="/files/<%= file.id %>/download" class="btn btn-outline-success">
                              <i class="fas fa-download"></i>
                            </a>
                            <a href="/superadmin/files/<%= file.id %>/edit" class="btn btn-outline-primary">
                              <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteFileModal" 
                                    data-id="<%= file.id %>" 
                                    data-name="<%= file.originalName %>">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-center py-4">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <p>Tidak ada file yang ditemukan untuk pengguna ini.</p>
              </div>
            <% } %>
          </div>
          
          <!-- Activity Tab -->
          <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
            <% if (activities && activities.length > 0) { %>
              <div class="timeline">
                <% activities.forEach(activity => { %>
                  <div class="timeline-item">
                    <div class="timeline-marker">
                      <i class="fas fa-<%= activity.type === 'login' ? 'sign-in-alt' : (activity.type === 'file_upload' ? 'upload' : (activity.type === 'data_created' ? 'plus-circle' : (activity.type === 'profile_update' ? 'user-edit' : 'circle'))) %>"></i>
                    </div>
                    <div class="timeline-content">
                      <h6 class="mb-1"><%= activity.description %></h6>
                      <small class="text-muted">
                        <i class="fas fa-clock me-1"></i> 
                        <%= new Date(activity.createdAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                      </small>
                      <% if (activity.metadata) { %>
                        <div class="text-muted small mt-1"><%= activity.metadata %></div>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <div class="text-center py-4">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <p>Tidak ada aktivitas yang tercatat untuk pengguna ini.</p>
              </div>
            <% } %>
          </div>
          
          <!-- Login Logs Tab -->
          <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
            <% if (loginLogs && loginLogs.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Waktu</th>
                      <th>IP Address</th>
                      <th>User Agent</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% loginLogs.forEach(log => { %>
                      <tr>
                        <td>
                          <%= new Date(log.timestamp).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                        </td>
                        <td><%= log.ipAddress %></td>
                        <td><%= log.userAgent %></td>
                        <td>
                          <% if (log.status === 'success') { %>
                            <span class="badge bg-success">Berhasil</span>
                          <% } else { %>
                            <span class="badge bg-danger">Gagal</span>
                          <% } %>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-center py-4">
                <i class="fas fa-list fa-3x text-muted mb-3"></i>
                <p>Tidak ada log login yang tercatat untuk pengguna ini.</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Konfirmasi Hapus</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus pengguna <strong><%= user.fullName %></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Aksi ini tidak dapat dibatalkan dan semua data yang terkait dengan pengguna ini akan ikut terhapus.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <form action="/superadmin/users/<%= user.id %>/delete" method="POST">
          <button type="submit" class="btn btn-danger">Hapus Pengguna</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Personal Data Modal -->
<div class="modal fade" id="deleteDataModal" tabindex="-1" aria-labelledby="deleteDataModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDataModalLabel">Konfirmasi Hapus Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus data <strong id="dataTitle"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Aksi ini tidak dapat dibatalkan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <form id="deleteDataForm" action="/superadmin/personal-data/:id/delete" method="POST">
          <button type="submit" class="btn btn-danger">Hapus Data</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete File Modal -->
<div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteFileModalLabel">Konfirmasi Hapus File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus file <strong id="fileName"></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Aksi ini tidak dapat dibatalkan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <form id="deleteFileForm" action="/superadmin/files/:id/delete" method="POST">
          <button type="submit" class="btn btn-danger">Hapus File</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Password toggle visibility
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          this.querySelector('i').classList.remove('fa-eye');
          this.querySelector('i').classList.add('fa-eye-slash');
        } else {
          passwordInput.type = 'password';
          this.querySelector('i').classList.remove('fa-eye-slash');
          this.querySelector('i').classList.add('fa-eye');
        }
      });
    });
    
    // Form validation for password reset
    const resetForm = document.querySelector('.needs-validation');
    if (resetForm) {
      resetForm.addEventListener('submit', function(event) {
        if (!resetForm.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        const newPassword = document.getElementById('newPassword');
        const confirmNewPassword = document.getElementById('confirmNewPassword');
        
        if (newPassword.value !== confirmNewPassword.value) {
          confirmNewPassword.setCustomValidity('Passwords do not match');
          event.preventDefault();
          event.stopPropagation();
        } else {
          confirmNewPassword.setCustomValidity('');
        }
        
        resetForm.classList.add('was-validated');
      });
    }
    
    // Data delete modal setup
    const deleteDataModal = document.getElementById('deleteDataModal');
    if (deleteDataModal) {
      deleteDataModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const dataId = button.getAttribute('data-id');
        const dataTitle = button.getAttribute('data-title');
        
        document.getElementById('dataTitle').textContent = dataTitle;
        document.getElementById('deleteDataForm').action = `/superadmin/personal-data/${dataId}/delete`;
      });
    }
    
    // File delete modal setup
    const deleteFileModal = document.getElementById('deleteFileModal');
    if (deleteFileModal) {
      deleteFileModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const fileId = button.getAttribute('data-id');
        const fileName = button.getAttribute('data-name');
        
        document.getElementById('fileName').textContent = fileName;
        document.getElementById('deleteFileForm').action = `/superadmin/files/${fileId}/delete`;
      });
    }
  });
</script>
