<!-- Personal Data Detail View -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-database me-2"></i> Detail Data Pribadi</h2>
  <div>
    <a href="/superadmin/personal-data/<%= personalData.id %>/edit" class="btn btn-outline-primary me-2">
      <i class="fas fa-edit me-1"></i> Edit Data
    </a>
    <a href="/superadmin/personal-data" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Kembali ke Daftar
    </a>
  </div>
</div>

<div class="row">
  <!-- Main Data Details -->
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Informasi Data</h5>
        <% if (personalData.isEncrypted) { %>
          <span class="badge bg-danger"><i class="fas fa-lock me-1"></i> Terenkripsi</span>
        <% } else { %>
          <span class="badge bg-success"><i class="fas fa-unlock me-1"></i> Tidak Terenkripsi</span>
        <% } %>
      </div>
      
      <div class="card-body">
        <div class="mb-4">
          <h4 class="text-danger"><%= personalData.title %></h4>
          <% if (personalData.description) { %>
            <p class="text-muted mb-0"><%= personalData.description %></p>
          <% } %>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="data-label">Kategori</div>
            <div class="data-value">
              <span class="badge bg-light text-dark border"><%= personalData.category %></span>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="data-label">Jenis Data</div>
            <div class="data-value">
              <% if (personalData.dataType === 'text') { %>
                <i class="fas fa-align-left text-primary me-1"></i> Teks
              <% } else if (personalData.dataType === 'file') { %>
                <i class="fas fa-file text-primary me-1"></i> File
              <% } %>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="data-label">Tanggal Dibuat</div>
            <div class="data-value">
              <%= new Date(personalData.createdAt).toLocaleDateString('id-ID', {
                year: 'numeric', month: 'long', day: 'numeric'
              }) %>
            </div>
          </div>
        </div>
        
        <!-- Content Section -->
        <% if (personalData.dataType === 'text' && (!personalData.isEncrypted || decryptedData)) { %>
          <div class="content-section">
            <h5 class="mb-3">Konten</h5>
            <div class="content-box p-3 bg-light rounded">
              <pre class="mb-0"><%= decryptedData || personalData.data %></pre>
            </div>
          </div>
        <% } else if (personalData.dataType === 'file') { %>
          <div class="content-section">
            <h5 class="mb-3">File</h5>
            <div class="file-box p-3 bg-light rounded d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fas fa-file fa-2x text-primary me-3"></i>
                <div>
                  <h6 class="mb-0"><%= personalData.fileName || 'File' %></h6>
                  <small class="text-muted"><%= personalData.fileSize ? formatFileSize(personalData.fileSize) : '' %></small>
                </div>
              </div>
              
              <div>
                <% if (!personalData.isEncrypted || decryptionKey) { %>
                  <a href="/superadmin/personal-data/<%= personalData.id %>/download<%= decryptionKey ? '?key=' + encodeURIComponent(decryptionKey) : '' %>" class="btn btn-primary btn-sm">
                    <i class="fas fa-download me-1"></i> Unduh
                  </a>
                <% } else { %>
                  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#decryptModal">
                    <i class="fas fa-download me-1"></i> Unduh
                  </button>
                <% } %>
              </div>
            </div>
          </div>
        <% } %>
        
        <% if (personalData.isEncrypted && !decryptedData && personalData.dataType === 'text') { %>
          <div class="alert alert-warning mt-4">
            <div class="d-flex align-items-center">
              <i class="fas fa-lock fa-2x me-3"></i>
              <div>
                <h5 class="mb-1">Data Terenkripsi</h5>
                <p class="mb-3">Data ini terenkripsi dan memerlukan kunci untuk membukanya.</p>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#decryptModal">
                  <i class="fas fa-key me-1"></i> Buka dengan Kunci
                </button>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
    
    <!-- Version History (if applicable) -->
    <% if (versions && versions.length > 0) { %>
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fas fa-history me-2"></i> Riwayat Perubahan</h5>
        </div>
        <div class="list-group list-group-flush">
          <% versions.forEach(version => { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">Versi <%= version.versionNumber %></h6>
                  <small class="text-muted">
                    Diubah pada <%= new Date(version.createdAt).toLocaleDateString('id-ID', {
                      year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) %>
                  </small>
                </div>
                <a href="/superadmin/personal-data/version/<%= version.id %>" class="btn btn-sm btn-outline-secondary">
                  Lihat
                </a>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
  </div>
  
  <!-- Sidebar Information -->
  <div class="col-lg-4">
    <!-- User Information -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-user me-2"></i> Informasi Pengguna</h5>
      </div>
      <div class="card-body">
        <% if (personalData.user) { %>
          <div class="text-center mb-3">
            <div class="avatar avatar-lg mx-auto mb-3 bg-<%= personalData.user.role === 'superadmin' ? 'danger' : (personalData.user.role === 'admin' ? 'warning' : 'info') %>">
              <%= personalData.user.fullName.substring(0, 2).toUpperCase() %>
            </div>
            <h5 class="mb-1"><%= personalData.user.fullName %></h5>
            <p class="mb-1"><%= personalData.user.email %></p>
            <span class="badge bg-<%= personalData.user.role === 'superadmin' ? 'danger' : (personalData.user.role === 'admin' ? 'warning' : 'info') %>">
              <%= personalData.user.role.charAt(0).toUpperCase() + personalData.user.role.slice(1) %>
            </span>
          </div>
          
          <hr>
          
          <div class="user-details">
            <div class="mb-2 d-flex">
              <div class="detail-label">ID Pengguna:</div>
              <div class="detail-value">#<%= personalData.user.id %></div>
            </div>
            <div class="mb-2 d-flex">
              <div class="detail-label">Status:</div>
              <div class="detail-value">
                <span class="badge bg-<%= personalData.user.active ? 'success' : 'danger' %>">
                  <%= personalData.user.active ? 'Aktif' : 'Tidak Aktif' %>
                </span>
              </div>
            </div>
            <div class="mb-2 d-flex">
              <div class="detail-label">Bergabung:</div>
              <div class="detail-value">
                <%= new Date(personalData.user.createdAt).toLocaleDateString('id-ID', {
                  year: 'numeric', month: 'short', day: 'numeric'
                }) %>
              </div>
            </div>
          </div>
          
          <div class="d-grid gap-2 mt-3">
            <a href="/superadmin/users/<%= personalData.user.id %>" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-user me-1"></i> Lihat Profil
            </a>
            <a href="/superadmin/personal-data?user=<%= personalData.user.id %>" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-database me-1"></i> Lihat Semua Data
            </a>
          </div>
        <% } else { %>
          <div class="text-center py-4">
            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
            <p class="mb-0">Pengguna tidak ditemukan atau telah dihapus.</p>
          </div>
        <% } %>
      </div>
    </div>
    
    <!-- Access Log -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Log Akses</h5>
      </div>
      <% if (accessLogs && accessLogs.length > 0) { %>
        <div class="list-group list-group-flush">
          <% accessLogs.slice(0, 5).forEach(log => { %>
            <div class="list-group-item">
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm me-3 bg-<%= log.user.role === 'superadmin' ? 'danger' : (log.user.role === 'admin' ? 'warning' : 'info') %>">
                  <%= log.user.fullName.substring(0, 2).toUpperCase() %>
                </div>
                <div>
                  <div class="fw-bold"><%= log.user.fullName %></div>
                  <div class="small text-muted d-flex align-items-center">
                    <span class="me-2"><%= log.action %></span>
                    <i class="fas fa-clock me-1 small"></i>
                    <%= new Date(log.createdAt).toLocaleDateString('id-ID', {
                      hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short'
                    }) %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
        <% if (accessLogs.length > 5) { %>
          <div class="card-footer bg-white text-center">
            <a href="/superadmin/personal-data/<%= personalData.id %>/logs" class="text-decoration-none">
              Lihat Semua Log <i class="fas fa-angle-right ms-1"></i>
            </a>
          </div>
        <% } %>
      <% } else { %>
        <div class="card-body text-center py-4">
          <i class="fas fa-clock fa-3x text-muted mb-3"></i>
          <p class="mb-0">Belum ada aktivitas log.</p>
        </div>
      <% } %>
    </div>
    
    <!-- Actions -->
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-cog me-2"></i> Tindakan</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/superadmin/personal-data/<%= personalData.id %>/edit" class="btn btn-outline-primary">
            <i class="fas fa-edit me-1"></i> Edit Data
          </a>
          
          <% if (personalData.dataType === 'file' && (!personalData.isEncrypted || decryptionKey)) { %>
            <a href="/superadmin/personal-data/<%= personalData.id %>/download<%= decryptionKey ? '?key=' + encodeURIComponent(decryptionKey) : '' %>" class="btn btn-outline-success">
              <i class="fas fa-download me-1"></i> Unduh File
            </a>
          <% } %>
          
          <% if (personalData.isEncrypted && !decryptedData) { %>
            <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#decryptModal">
              <i class="fas fa-unlock-alt me-1"></i> Dekripsi Data
            </button>
          <% } %>
          
          <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="fas fa-trash-alt me-1"></i> Hapus Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Decrypt Modal -->
<!-- Add hidden field for decrypt error status -->
<input type="hidden" id="hasDecryptError" value="<%= locals.decryptError ? 'true' : 'false' %>">
<div class="modal fade" id="decryptModal" tabindex="-1" aria-labelledby="decryptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="decryptModalLabel">Dekripsi Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/superadmin/personal-data/<%= personalData.id %>/decrypt" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="decryptionKey" class="form-label">Kunci Dekripsi</label>
            <div class="input-group">
              <input type="password" class="form-control" id="decryptionKey" name="decryptionKey" required>
              <button class="btn btn-outline-secondary" type="button" id="toggleDecryptKey">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="form-text">Masukkan kunci dekripsi untuk membuka data.</div>
          </div>
          
          <% if (locals.decryptError) { %>
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i> <%= decryptError %>
            </div>
          <% } %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-danger">Dekripsi</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Konfirmasi Hapus</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus data <strong><%= personalData.title %></strong>?</p>
        <p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Aksi ini tidak dapat dibatalkan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <form action="/superadmin/personal-data/<%= personalData.id %>/delete" method="POST">
          <button type="submit" class="btn btn-danger">Hapus Data</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle password visibility for decrypt modal
    const toggleDecryptKey = document.getElementById('toggleDecryptKey');
    const decryptionKey = document.getElementById('decryptionKey');
    
    if (toggleDecryptKey && decryptionKey) {
      toggleDecryptKey.addEventListener('click', function() {
        const type = decryptionKey.getAttribute('type') === 'password' ? 'text' : 'password';
        decryptionKey.setAttribute('type', type);
        
        // toggle the icon
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
      });
    }
    
    // Auto-show decrypt modal if there's an error
    const hasDecryptError = document.getElementById('hasDecryptError').value === 'true';
    if (hasDecryptError) {
      new bootstrap.Modal(document.getElementById('decryptModal')).show();
    }
  });
</script>

<style>
  .avatar {
    width: 36px;
    height: 36px;
    line-height: 36px;
    border-radius: 50%;
    display: inline-block;
    color: #fff;
    text-align: center;
    font-weight: 500;
  }
  
  .avatar-lg {
    width: 64px;
    height: 64px;
    line-height: 64px;
    font-size: 24px;
  }
  
  .avatar-sm {
    width: 24px;
    height: 24px;
    line-height: 24px;
    font-size: 10px;
  }
  
  .data-label {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
  }
  
  .data-value {
    font-weight: 500;
  }
  
  .content-box {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
  }
  
  .content-box pre {
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  .file-box {
    border: 1px solid #dee2e6;
  }
  
  .user-details .detail-label {
    width: 120px;
    color: #6c757d;
  }
  
  .user-details .detail-value {
    flex: 1;
    font-weight: 500;
  }
</style>
